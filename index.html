<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ù†Ù…ÙˆØ°Ø¬ Ø§Ø³ØªÙ„Ø§Ù… Ø¬ÙˆØ± Ø£Ø¹Ù…Ø¯Ø©</title>
  <style>
    body {
      font-family: 'Arial', sans-serif;
      background-color: #111;
      color: #f0f0f0;
      direction: rtl;
      padding: 10px;
      margin: 0;
      box-sizing: border-box;
    }
    .section {
      background: #1e1e1e;
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 20px;
      box-shadow: 0 0 5px #333;
      max-width: 600px;
      margin-left: auto;
      margin-right: auto;
    }
    label {
      display: block;
      margin: 8px 0 4px;
    }
    input, select, textarea {
      width: calc(100% - 12px);
      padding: 6px;
      margin-bottom: 10px;
      border: 1px solid #444;
      border-radius: 5px;
      background-color: #222;
      color: #f0f0f0;
      box-sizing: border-box;
    }
    button {
      background-color: #28a745;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 5px;
      cursor: pointer;
      margin-top: 10px;
      margin-left: 5px;
      width: auto;
      display: inline-block;
    }
    button.remove-btn {
      background-color: #dc3545;
      margin-top: 5px;
      padding: 5px 10px;
      font-size: 0.8em;
      float: left;
      width: auto;
    }
    button.remove-btn:hover {
      background-color: #c82333;
    }
    button:hover {
      background-color: #218838;
    }
    .column-box {
      border: 1px solid #444;
      padding: 10px;
      border-radius: 8px;
      margin-bottom: 15px;
      background-color: #2a2a2a;
      position: relative;
    }
    .sub-section-header {
        color: #bbb;
        margin-top: 15px;
        margin-bottom: 8px;
        border-bottom: 1px dashed #555;
        padding-bottom: 5px;
    }
    h2 {
      text-align: center;
      margin-bottom: 20px;
    }
    h3 {
        margin-top: 25px;
        margin-bottom: 10px;
        color: #eee;
        text-align: center;
    }
    h4 {
        margin-top: 10px;
        margin-bottom: 10px;
        color: #ddd;
        text-align: center;
    }
    .saved-list {
      background-color: #1e1e1e;
      padding: 15px;
      border-radius: 10px;
      box-shadow: 0 0 5px #333;
      margin-top: 30px;
      max-width: 600px;
      margin-left: auto;
      margin-right: auto;
    }
    .saved-item {
      background-color: #2a2a2a;
      padding: 10px;
      margin-bottom: 10px;
      border-radius: 8px;
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 10px;
    }
    .saved-item-info {
        flex-grow: 1;
    }
    .saved-item-actions {
        display: flex;
        flex-wrap: wrap;
        gap: 5px;
    }
    .saved-item-actions button {
        padding: 5px 10px;
        font-size: 0.8em;
        margin: 0;
        min-width: 60px;
    }
    .saved-item-actions button.view-btn {
        background-color: #007bff;
    }
    .saved-item-actions button.view-btn:hover {
        background-color: #0056b3;
    }
    .saved-item-actions button.delete-btn {
        background-color: #dc3545;
    }
    .saved-item-actions button.delete-btn:hover {
        background-color: #c82333;
    }
    .saved-item-actions button.edit-btn {
        background-color: #ffc107;
        color: #333;
    }
    .saved-item-actions button.edit-btn:hover {
        background-color: #e0a800;
    }
    .saved-item-actions button.export-btn {
        background-color: #17a2b8;
    }
    .saved-item-actions button.export-btn:hover {
        background-color: #138496;
    }
    .search-box {
      margin-bottom: 20px;
    }
    .detail-view {
        background-color: #2a2a2a;
        padding: 15px;
        border-radius: 8px;
        margin-top: 15px;
        border: 1px solid #444;
        width: 100%;
        box-sizing: border-box;
    }
    .detail-view h4 {
        border-bottom: 1px solid #444;
        padding-bottom: 5px;
        margin-bottom: 10px;
    }
    .detail-column-item {
        background-color: #333;
        padding: 8px;
        border-radius: 5px;
        margin-bottom: 8px;
        border: 1px dashed #555;
    }
    #saveBtn {
        background-color: #28a745;
    }
    #updateBtn {
        background-color: #ffc107;
        color: #333;
        display: none;
    }
    #cancelUpdateBtn {
        background-color: #6c757d;
        display: none;
    }
    #exportSelectedBtn {
        background-color: #007bff;
        margin-top: 15px;
        width: 100%;
        box-sizing: border-box;
    }
    .checkbox-container {
        flex-shrink: 0;
        margin-left: 10px;
    }

    /* Media Queries */
    @media (max-width: 480px) {
        body {
            padding: 5px;
            font-size: 0.9em;
        }
        .section, .saved-list {
            padding: 10px;
        }
        button {
            padding: 8px 10px;
            font-size: 0.9em;
        }
        .saved-item {
            flex-direction: column;
            align-items: flex-start;
        }
        .saved-item-actions {
            margin-top: 10px;
            width: 100%;
            justify-content: space-between;
        }
        .saved-item-actions button {
            flex-grow: 1;
            min-width: unset;
        }
        .checkbox-container {
            margin-bottom: 10px;
        }
    }
  </style>
</head>
<body>

  <h2>Ù†Ù…ÙˆØ°Ø¬ Ø§Ø³ØªÙ„Ø§Ù… Ø¬ÙˆØ± Ø£Ø¹Ù…Ø¯Ø©</h2>

  <div class="section" id="main-form">
    <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©:</label>
    <input type="text" id="transaction_name">

    <label>Ø±Ù‚Ù… Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©:</label>
    <input type="text" id="transaction_number">

    <label>Ø§Ø³Ù… Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„ / Ø§Ù„Ø´Ø±ÙƒØ©:</label>
    <select id="contractor">
        <option value="">Ø§Ø®ØªØ± Ù…Ù‚Ø§ÙˆÙ„...</option>
        <option value="Ø£Ù‡Ù„ Ø§Ù„Ù‡Ù…Ø©">Ø£Ù‡Ù„ Ø§Ù„Ù‡Ù…Ø©</option>
        <option value="Ø¹Ø²Ø§Ù… Ø§Ù„Ù†Ù…Ø±">Ø¹Ø²Ø§Ù… Ø§Ù„Ù†Ù…Ø±</option>
        <option value="Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡ Ø¹ÙˆØ§Ø¯">Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡ Ø¹ÙˆØ§Ø¯</option>
        <option value="Ø§Ù„Ù„ÙŠÙˆØ§Ù†">Ø§Ù„Ù„ÙŠÙˆØ§Ù†</option>
        <option value="Ø£Ø­Ù…Ø¯ Ø¬Ø¨Ø±">Ø£Ø­Ù…Ø¯ Ø¬Ø¨Ø±</option>
        <option value="Ø¹Ø¨Ø¯Ø§Ù„Ø³Ù„Ø§Ù… Ø§Ù„Ù…Ø¹Ø§ÙŠØ·Ø©">Ø¹Ø¨Ø¯Ø§Ù„Ø³Ù„Ø§Ù… Ø§Ù„Ù…Ø¹Ø§ÙŠØ·Ø©</option>
        <option value="Ø§Ù„Ù‡Ù…Ø´Ø±ÙŠ">Ø§Ù„Ù‡Ù…Ø´Ø±ÙŠ</option>
    </select>

    <label>Ø§Ù„Ù…ÙˆÙ‚Ø¹:</label>
    <input type="text" id="location">

    <label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…:</label>
    <input type="date" id="date">

    <label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¹Ø§Ù…Ø©:</label>
    <textarea rows="3" id="general_notes"></textarea>
  </div>

  <h3>ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¬ÙˆØ± / Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©</h3>
  <div class="section">
    <div id="columns-container"></div>
    <button onclick="addColumn()">â• Ø¥Ø¶Ø§ÙØ© ØªÙØµÙŠÙ„Ø© Ø¹Ù…ÙˆØ¯</button>
  </div>
  <br>
  <button id="saveBtn" onclick="saveData()">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
  <button id="updateBtn" onclick="updateData()">âœ”ï¸ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
  <button id="cancelUpdateBtn" onclick="cancelUpdate()">âœ–ï¸ Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„</button>

  <div class="saved-list">
    <h3>ğŸ“‹ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©</h3>
    <div class="search-box">
      <label>ğŸ” Ø¨Ø­Ø«:</label>
      <input type="text" id="searchInput" placeholder="Ø§Ø³Ù… Ø£Ùˆ Ø±Ù‚Ù… Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©..." oninput="renderSavedData()">
    </div>
    <div id="savedData"></div>
    <button id="exportSelectedBtn" onclick="exportSelectedData()" style="display:none;">ğŸ“¥ ØªØµØ¯ÙŠØ± Ø§Ù„Ù…Ø­Ø¯Ø¯</button>
  </div>

  <script>
    let columnCount = 0;
    let currentEditKey = null;

    function addColumn(colData = null) {
      columnCount++;
      const container = document.getElementById('columns-container');
      const div = document.createElement('div');
      div.className = 'column-box';
      div.id = `column_box_${columnCount}`;
      div.innerHTML = `
        <button class="remove-btn" onclick="removeColumn(${columnCount})">âœ–ï¸ Ø¥Ø²Ø§Ù„Ø©</button>
        <h4>ØªÙØµÙŠÙ„Ø© Ø±Ù‚Ù… ${columnCount}</h4>
        <h5 class="sub-section-header">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙˆØ¯</h5>
        <label>Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…ÙˆØ¯:</label>
        <select id="pole_type_${columnCount}">
          <option value="3.5">3.5</option>
          <option value="4.5">4.5</option>
          <option value="5.5">5.5</option>
          <option value="Ù…Ø§Ø³ÙˆØ±Ø©">Ù…Ø§Ø³ÙˆØ±Ø©</option>
          <option value="Ù…Ø¶Ù„Ø¹">Ù…Ø¶Ù„Ø¹</option>
          <option value="Ø¶.Ø¹">Ø¶.Ø¹</option>
          <option value="ÙÙŠØ§Ø¯Ø±">ÙÙŠØ§Ø¯Ø±</option>
          <option value="Ù„Ø§ ÙŠÙˆØ¬Ø¯">Ù„Ø§ ÙŠÙˆØ¬Ø¯</option>
        </select>
        <div id="pole_details_${columnCount}">
          <label>Ù†ÙˆØ¹ Ø§Ù„Ø­ÙØ± (Ø§Ù„Ø¹Ù…ÙˆØ¯):</label>
          <select id="dig_type_${columnCount}">
            <option>Ø¨Ù„Ø§Ø·</option>
            <option>Ø¨Ø§Ø·ÙˆÙ†</option>
            <option>Ø£Ø³ÙÙ„Øª</option>
            <option>ØªØ±Ø§Ø¨</option>
          </select>
          <label>Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© (Ù„Ù„ØªÙØµÙŠÙ„Ø© Ø§Ù„ÙˆØ§Ø­Ø¯Ø©):</label>
          <input type="number" step="1" min="1" value="1" id="quantity_of_poles_${columnCount}">
          <label>Ø·ÙˆÙ„ Ø§Ù„Ø¹Ù…ÙˆØ¯ (Ø³Ù…):</label>
          <input type="number" step="1" id="length_${columnCount}">
          <label>Ø¹Ø±Ø¶ Ø§Ù„Ø¹Ù…ÙˆØ¯ (Ø³Ù…):</label>
          <input type="number" step="1" id="width_${columnCount}">
          <label>Ø¹Ù…Ù‚ Ø§Ù„Ø¹Ù…ÙˆØ¯ (Ø³Ù…):</label>
          <input type="number" step="1" id="depth_${columnCount}">
        </div>
        <h5 class="sub-section-header">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³ØªÙŠ/Ø§Ù„Ù…Ø±Ø¨Ø·</h5>
        <label>Ù†ÙˆØ¹ Ø§Ù„Ø³ØªÙŠ / Ø§Ù„Ù…Ø±Ø¨Ø·:</label>
        <select id="tie_type_${columnCount}">
          <option value="Ø³ØªÙŠ">Ø³ØªÙŠ</option>
          <option value="Ø³ØªÙŠ Ø¶.Ø¹">Ø³ØªÙŠ Ø¶.Ø¹</option>
          <option value="Ø³ØªÙŠ Ù„ØºÙ…">Ø³ØªÙŠ Ù„ØºÙ…</option>
          <option value="Ù„Ø§ ÙŠÙˆØ¬Ø¯">Ù„Ø§ ÙŠÙˆØ¬Ø¯</option>
        </select>
        <div id="tie_details_${columnCount}">
            <label>Ù†ÙˆØ¹ Ø­ÙØ± Ø§Ù„Ø³ØªÙŠ:</label>
            <select id="tie_dig_type_${columnCount}">
                <option>ØªØ±Ø§Ø¨</option>
                <option>Ø¨Ø§Ø·ÙˆÙ†</option>
                <option>Ø£Ø³ÙÙ„Øª</option>
                <option>Ø¨Ù„Ø§Ø·</option>
            </select>
            <label>Ø·ÙˆÙ„ Ø§Ù„Ø³ØªÙŠ (Ø³Ù…):</label>
            <input type="number" step="1" id="tie_length_${columnCount}">
            <label>Ø¹Ø±Ø¶ Ø§Ù„Ø³ØªÙŠ (Ø³Ù…):</label>
            <input type="number" step="1" id="tie_width_${columnCount}">
            <label>Ø¹Ù…Ù‚ Ø§Ù„Ø³ØªÙŠ (Ø³Ù…):</label>
            <input type="number" step="1" id="tie_depth_${columnCount}">
            <label>Ø¹Ø¯Ø¯ Ø§Ù„Ø³ØªÙŠØ§Øª (Ù„Ù„ØªÙØµÙŠÙ„Ø© Ø§Ù„ÙˆØ§Ø­Ø¯Ø©):</label>
            <input type="number" step="1" min="0" value="1" id="quantity_of_ties_${columnCount}">
        </div>
        <label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ù„Ù„ØªÙØµÙŠÙ„Ø©:</label>
        <textarea rows="2" id="column_note_${columnCount}"></textarea>
      `;
      container.appendChild(div);

      // Populate with data if available (for editing)
      if (colData) {
        document.getElementById(`pole_type_${columnCount}`).value = colData.pole_type || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯';
        document.getElementById(`column_note_${columnCount}`).value = colData.note || '';

        const poleDetailsDiv = document.getElementById(`pole_details_${columnCount}`);
        if (colData.pole_type === 'Ù„Ø§ ÙŠÙˆØ¬Ø¯') {
            poleDetailsDiv.style.display = 'none';
        } else {
            poleDetailsDiv.style.display = 'block';
            document.getElementById(`dig_type_${columnCount}`).value = colData.dig_type || '';
            document.getElementById(`quantity_of_poles_${columnCount}`).value = colData.quantity_of_poles || '1';
            document.getElementById(`length_${columnCount}`).value = colData.length || '';
            document.getElementById(`width_${columnCount}`).value = colData.width || '';
            document.getElementById(`depth_${columnCount}`).value = colData.depth || '';
        }

        const tieDetailsDiv = document.getElementById(`tie_details_${columnCount}`);
        document.getElementById(`tie_type_${columnCount}`).value = colData.tie_type || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯';
        if (colData.tie_type === 'Ù„Ø§ ÙŠÙˆØ¬Ø¯') {
            tieDetailsDiv.style.display = 'none';
        } else {
            tieDetailsDiv.style.display = 'block';
            document.getElementById(`tie_dig_type_${columnCount}`).value = colData.tie_dig_type || '';
            document.getElementById(`tie_length_${columnCount}`).value = colData.tie_length || '';
            document.getElementById(`tie_width_${columnCount}`).value = colData.tie_width || '';
            document.getElementById(`tie_depth_${columnCount}`).value = colData.tie_depth || '';
            document.getElementById(`quantity_of_ties_${columnCount}`).value = colData.quantity_of_ties || '1';
        }
      }

      // Add event listener for pole type change
      document.getElementById(`pole_type_${columnCount}`).addEventListener('change', function() {
          const poleType = this.value;
          const poleDetailsDiv = document.getElementById(`pole_details_${columnCount}`);
          if (poleType === 'Ù„Ø§ ÙŠÙˆØ¬Ø¯') {
              poleDetailsDiv.style.display = 'none';
              document.getElementById(`quantity_of_poles_${columnCount}`).value = '0';
          } else {
              poleDetailsDiv.style.display = 'block';
              if (document.getElementById(`quantity_of_poles_${columnCount}`).value === '0') {
                 document.getElementById(`quantity_of_poles_${columnCount}`).value = '1';
              }
          }
      });
      // Add event listener for tie type change
      document.getElementById(`tie_type_${columnCount}`).addEventListener('change', function() {
          const tieType = this.value;
          const tieDetailsDiv = document.getElementById(`tie_details_${columnCount}`);
          if (tieType === 'Ù„Ø§ ÙŠÙˆØ¬Ø¯') {
              tieDetailsDiv.style.display = 'none';
              document.getElementById(`quantity_of_ties_${columnCount}`).value = '0';
          } else {
              tieDetailsDiv.style.display = 'block';
              if (document.getElementById(`quantity_of_ties_${columnCount}`).value === '0') {
                 document.getElementById(`quantity_of_ties_${columnCount}`).value = '1';
              }
          }
      });
    }

    function removeColumn(id) {
        const element = document.getElementById(`column_box_${id}`);
        if (element) {
            element.remove();
        }
    }

    function saveData() {
      const data = collectFormData();
      const key = "maamala_" + new Date().toISOString();
      localStorage.setItem(key, JSON.stringify(data));
      alert("âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!");
      clearForm();
      renderSavedData();
    }

    function collectFormData() {
      const data = {
        transaction_name: document.getElementById("transaction_name").value,
        transaction_number: document.getElementById("transaction_number").value,
        contractor: document.getElementById("contractor").value,
        location: document.getElementById("location").value,
        date: document.getElementById("date").value,
        general_notes: document.getElementById("general_notes").value,
        columns: []
      };

      const columnBoxes = document.querySelectorAll('.column-box');
      columnBoxes.forEach(box => {
          const id = box.id.split('_')[2];
          const poleType = document.getElementById(`pole_type_${id}`).value;
          const tieType = document.getElementById(`tie_type_${id}`).value;
          const col = {
            id: id,
            pole_type: poleType,
            dig_type: (poleType !== 'Ù„Ø§ ÙŠÙˆØ¬Ø¯') ? document.getElementById(`dig_type_${id}`).value : '',
            quantity_of_poles: (poleType !== 'Ù„Ø§ ÙŠÙˆØ¬Ø¯') ? document.getElementById(`quantity_of_poles_${id}`).value : '0',
            length: (poleType !== 'Ù„Ø§ ÙŠÙˆØ¬Ø¯') ? document.getElementById(`length_${id}`).value : '',
            width: (poleType !== 'Ù„Ø§ ÙŠÙˆØ¬Ø¯') ? document.getElementById(`width_${id}`).value : '',
            depth: (poleType !== 'Ù„Ø§ ÙŠÙˆØ¬Ø¯') ? document.getElementById(`depth_${id}`).value : '',
            tie_type: tieType,
            tie_dig_type: (tieType !== 'Ù„Ø§ ÙŠÙˆØ¬Ø¯') ? document.getElementById(`tie_dig_type_${id}`).value : '',
            tie_length: (tieType !== 'Ù„Ø§ ÙŠÙˆØ¬Ø¯') ? document.getElementById(`tie_length_${id}`).value : '',
            tie_width: (tieType !== 'Ù„Ø§ ÙŠÙˆØ¬Ø¯') ? document.getElementById(`tie_width_${id}`).value : '',
            tie_depth: (tieType !== 'Ù„Ø§ ÙŠÙˆØ¬Ø¯') ? document.getElementById(`tie_depth_${id}`).value : '',
            quantity_of_ties: (tieType !== 'Ù„Ø§ ÙŠÙˆØ¬Ø¯') ? document.getElementById(`quantity_of_ties_${id}`).value : '0',
            note: document.getElementById(`column_note_${id}`).value
          };
          data.columns.push(col);
      });
      return data;
    }

    function renderSavedData() {
      const savedDiv = document.getElementById("savedData");
      savedDiv.innerHTML = "";
      const search = document.getElementById("searchInput").value.toLowerCase();
      let savedKeys = Object.keys(localStorage).filter(key => key.startsWith("maamala_"));
      savedKeys.sort((a, b) => b.localeCompare(a));
      
      let hasData = false;

      savedKeys.forEach(key => {
          const data = JSON.parse(localStorage.getItem(key));
          if (
            (data.transaction_name && data.transaction_name.toLowerCase().includes(search)) ||
            (data.transaction_number && data.transaction_number.toLowerCase().includes(search))
          ) {
            hasData = true;
            let totalPoles = 0;
            let totalTies = 0;
            data.columns.forEach(col => {
                totalPoles += parseInt(col.quantity_of_poles || 0);
                if (col.tie_type && col.tie_type !== 'Ù„Ø§ ÙŠÙˆØ¬Ø¯' && col.quantity_of_ties) {
                    totalTies += parseInt(col.quantity_of_ties);
                }
            });

            const item = document.createElement("div");
            item.className = "saved-item";
            item.innerHTML = `
              <div class="checkbox-container">
                  <input type="checkbox" data-key="${key}" class="export-checkbox">
              </div>
              <div class="saved-item-info">
                  <strong>Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©:</strong> ${data.transaction_name || 'N/A'}<br>
                  <strong>Ø±Ù‚Ù… Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©:</strong> ${data.transaction_number || 'N/A'}<br>
                  <strong>Ø§Ù„Ù…ÙˆÙ‚Ø¹:</strong> ${data.location || 'N/A'}<br>
                  <strong>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©:</strong> ${totalPoles}<br>
                  <strong>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¹Ø¯Ø¯ Ø§Ù„Ø³ØªÙŠØ§Øª:</strong> ${totalTies}
              </div>
              <div class="saved-item-actions">
                  <button class="delete-btn" onclick="deleteData('${key}')">ğŸ—‘ï¸ Ø­Ø°Ù</button>
                  <button class="edit-btn" onclick="editData('${key}')">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
                  <button class="view-btn" onclick="viewData('${key}')">Ø¹Ø±Ø¶</button>
                  <button class="export-btn" onclick="exportData('${key}')">ğŸ“¥ ØªØµØ¯ÙŠØ±</button>
              </div>
              <div id="detail_view_${key.replace(/\./g, '_')}" class="detail-view" style="display:none;"></div>
            `;
            savedDiv.appendChild(item);
          }
      });
      
      const exportSelectedBtn = document.getElementById('exportSelectedBtn');
      if (hasData) {
          exportSelectedBtn.style.display = 'block';
      } else {
          exportSelectedBtn.style.display = 'none';
      }
    }

    function deleteData(key) {
        if (confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ø£Ù†Ùƒ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©ØŸ")) {
            localStorage.removeItem(key);
            alert("ğŸ—‘ï¸ ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­!");
            renderSavedData();
        }
    }

    function viewData(key) {
        const detailViewId = `detail_view_${key.replace(/\./g, '_')}`;
        const detailDiv = document.getElementById(detailViewId);
        if (detailDiv.style.display === 'block') {
            detailDiv.style.display = 'none';
            return;
        }
        detailDiv.innerHTML = '';
        const data = JSON.parse(localStorage.getItem(key));
        let htmlContent = `
            <h4>Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¹Ø§Ù…Ø©:</h4>
            <p><strong>Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©:</strong> ${data.transaction_name || 'N/A'}</p>
            <p><strong>Ø±Ù‚Ù… Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©:</strong> ${data.transaction_number || 'N/A'}</p>
            <p><strong>Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„:</strong> ${data.contractor || 'N/A'}</p>
            <p><strong>Ø§Ù„Ù…ÙˆÙ‚Ø¹:</strong> ${data.location || 'N/A'}</p>
            <p><strong>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…:</strong> ${data.date || 'N/A'}</p>
            <p><strong>Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¹Ø§Ù…Ø©:</strong> ${data.general_notes || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯'}</p>
            <hr>
            <h4>ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¬ÙˆØ± / Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©:</h4>
        `;
        if (data.columns && data.columns.length > 0) {
            data.columns.forEach((col, index) => {
                htmlContent += `
                    <div class="detail-column-item">
                        <h5>Ø§Ù„ØªÙØµÙŠÙ„Ø© Ø±Ù‚Ù… ${index + 1}</h5>
                        <p class="sub-section-header">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙˆØ¯:</p>
                        <ul>
                            <li><strong>Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…ÙˆØ¯:</strong> ${col.pole_type || 'N/A'}</li>
                `;
                if (col.pole_type && col.pole_type !== 'Ù„Ø§ ÙŠÙˆØ¬Ø¯') {
                    htmlContent += `
                            <li><strong>Ù†ÙˆØ¹ Ø§Ù„Ø­ÙØ±:</strong> ${col.dig_type || 'N/A'}</li>
                            <li><strong>Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©:</strong> ${col.quantity_of_poles || 1}</li>
                            <li><strong>Ø§Ù„Ø·ÙˆÙ„:</strong> ${col.length || 'N/A'} Ø³Ù…</li>
                            <li><strong>Ø§Ù„Ø¹Ø±Ø¶:</strong> ${col.width || 'N/A'} Ø³Ù…</li>
                            <li><strong>Ø§Ù„Ø¹Ù…Ù‚:</strong> ${col.depth || 'N/A'} Ø³Ù…</li>
                    `;
                }
                htmlContent += `
                        </ul>
                `;
                if (col.tie_type && col.tie_type !== 'Ù„Ø§ ÙŠÙˆØ¬Ø¯') {
                     htmlContent += `
                            <p class="sub-section-header">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³ØªÙŠ/Ø§Ù„Ù…Ø±Ø¨Ø·:</p>
                            <ul>
                                <li><strong>Ù†ÙˆØ¹ Ø§Ù„Ø³ØªÙŠ/Ø§Ù„Ù…Ø±Ø¨Ø·:</strong> ${col.tie_type}</li>
                                <li><strong>Ù†ÙˆØ¹ Ø­ÙØ± Ø§Ù„Ø³ØªÙŠ:</strong> ${col.tie_dig_type || 'N/A'}</li>
                                <li><strong>Ø·ÙˆÙ„ Ø§Ù„Ø³ØªÙŠ:</strong> ${col.tie_length || 'N/A'} Ø³Ù…</li>
                                <li><strong>Ø¹Ø±Ø¶ Ø§Ù„Ø³ØªÙŠ:</strong> ${col.tie_width || 'N/A'} Ø³Ù…</li>
                                <li><strong>Ø¹Ù…Ù‚ Ø§Ù„Ø³ØªÙŠ:</strong> ${col.tie_depth || 'N/A'} Ø³Ù…</li>
                                <li><strong>Ø¹Ø¯Ø¯ Ø§Ù„Ø³ØªÙŠØ§Øª:</strong> ${col.quantity_of_ties || 1}</li>
                            </ul>
                    `;
                } else {
                     htmlContent += `<p><strong>Ù†ÙˆØ¹ Ø§Ù„Ø³ØªÙŠ/Ø§Ù„Ù…Ø±Ø¨Ø·:</strong> Ù„Ø§ ÙŠÙˆØ¬Ø¯</p>`;
                }
                htmlContent += `
                            <p><strong>Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</strong> ${col.note || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯'}</p>
                        </div>
                `;
            });
        } else {
            htmlContent += '<p>Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙØ§ØµÙŠÙ„ Ø£Ø¹Ù…Ø¯Ø© Ù…Ø³Ø¬Ù„Ø© Ù„Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©.</p>';
        }
        detailDiv.innerHTML = htmlContent;
        detailDiv.style.display = 'block';
    }

    function editData(key) {
        const data = JSON.parse(localStorage.getItem(key));
        if (!data) {
            alert('Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØ¹Ø¯ÙŠÙ„.');
            return;
        }

        clearForm();
        currentEditKey = key;

        document.getElementById("transaction_name").value = data.transaction_name || '';
        document.getElementById("transaction_number").value = data.transaction_number || '';
        document.getElementById("contractor").value = data.contractor || '';
        document.getElementById("location").value = data.location || '';
        document.getElementById("date").value = data.date || '';
        document.getElementById("general_notes").value = data.general_notes || '';

        if (data.columns && data.columns.length > 0) {
            data.columns.forEach(col => addColumn(col));
        }

        document.getElementById("saveBtn").style.display = 'none';
        document.getElementById("updateBtn").style.display = 'inline-block';
        document.getElementById("cancelUpdateBtn").style.display = 'inline-block';

        document.getElementById("main-form").scrollIntoView({ behavior: 'smooth' });
    }

    function updateData() {
        if (!currentEditKey) {
            alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¹Ø§Ù…Ù„Ø© Ù…Ø­Ø¯Ø¯Ø© Ù„Ù„ØªØ­Ø¯ÙŠØ«.");
            return;
        }

        const data = collectFormData();
        localStorage.setItem(currentEditKey, JSON.stringify(data));
        alert("âœ”ï¸ ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!");
        clearForm();
        renderSavedData();
        currentEditKey = null;

        document.getElementById("saveBtn").style.display = 'inline-block';
        document.getElementById("updateBtn").style.display = 'none';
        document.getElementById("cancelUpdateBtn").style.display = 'none';
    }

    function cancelUpdate() {
        clearForm();
        currentEditKey = null;
        document.getElementById("saveBtn").style.display = 'inline-block';
        document.getElementById("updateBtn").style.display = 'none';
        document.getElementById("cancelUpdateBtn").style.display = 'none';
    }

    function clearForm() {
        document.getElementById("transaction_name").value = '';
        document.getElementById("transaction_number").value = '';
        document.getElementById("contractor").value = '';
        document.getElementById("location").value = '';
        document.getElementById("date").value = '';
        document.getElementById("general_notes").value = '';
        document.getElementById("columns-container").innerHTML = '';
        columnCount = 0;
    }

    function formatDataAsText(data) {
        let text = `
========================================
Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©
========================================
Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©: ${data.transaction_name || 'N/A'}
Ø±Ù‚Ù… Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©: ${data.transaction_number || 'N/A'}
Ø§Ø³Ù… Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„ / Ø§Ù„Ø´Ø±ÙƒØ©: ${data.contractor || 'N/A'}
Ø§Ù„Ù…ÙˆÙ‚Ø¹: ${data.location || 'N/A'}
ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…: ${data.date || 'N/A'}
Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¹Ø§Ù…Ø©: ${data.general_notes || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯'}
\n\n`;

        if (data.columns && data.columns.length > 0) {
            text += `========================================
ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¬ÙˆØ± / Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©
========================================
`;
            data.columns.forEach((col, index) => {
                text += `
----------------------------------------
Ø§Ù„ØªÙØµÙŠÙ„Ø© Ø±Ù‚Ù… ${index + 1}
----------------------------------------
* Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙˆØ¯:
  - Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…ÙˆØ¯: ${col.pole_type || 'N/A'}
`;
                if (col.pole_type && col.pole_type !== 'Ù„Ø§ ÙŠÙˆØ¬Ø¯') {
                    text += `
  - Ù†ÙˆØ¹ Ø§Ù„Ø­ÙØ±: ${col.dig_type || 'N/A'}
  - Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©: ${col.quantity_of_poles || 1}
  - Ø§Ù„Ø·ÙˆÙ„: ${col.length || 'N/A'} Ø³Ù…
  - Ø§Ù„Ø¹Ø±Ø¶: ${col.width || 'N/A'} Ø³Ù…
  - Ø§Ù„Ø¹Ù…Ù‚: ${col.depth || 'N/A'} Ø³Ù…
`;
                }
                
                if (col.tie_type && col.tie_type !== 'Ù„Ø§ ÙŠÙˆØ¬Ø¯') {
                    text += `
* Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³ØªÙŠ/Ø§Ù„Ù…Ø±Ø¨Ø·:
  - Ù†ÙˆØ¹ Ø§Ù„Ø³ØªÙŠ/Ø§Ù„Ù…Ø±Ø¨Ø·: ${col.tie_type}
  - Ù†ÙˆØ¹ Ø­ÙØ± Ø§Ù„Ø³ØªÙŠ: ${col.tie_dig_type || 'N/A'}
  - Ø·ÙˆÙ„ Ø§Ù„Ø³ØªÙŠ: ${col.tie_length || 'N/A'} Ø³Ù…
  - Ø¹Ø±Ø¶ Ø§Ù„Ø³ØªÙŠ: ${col.tie_width || 'N/A'} Ø³Ù…
  - Ø¹Ù…Ù‚ Ø§Ù„Ø³ØªÙŠ: ${col.tie_depth || 'N/A'} Ø³Ù…
  - Ø¹Ø¯Ø¯ Ø§Ù„Ø³ØªÙŠØ§Øª: ${col.quantity_of_ties || 1}
`;
                } else {
                    text += `
* Ù†ÙˆØ¹ Ø§Ù„Ø³ØªÙŠ/Ø§Ù„Ù…Ø±Ø¨Ø·: Ù„Ø§ ÙŠÙˆØ¬Ø¯
`;
                }
                text += `
* Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ù„Ù„ØªÙØµÙŠÙ„Ø©: ${col.note || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯'}
\n`;
            });
        } else {
            text += 'Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙØ§ØµÙŠÙ„ Ø£Ø¹Ù…Ø¯Ø© Ù…Ø³Ø¬Ù„Ø© Ù„Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©.\n';
        }
        text += '----------------------------------------\n\n';
        return text;
    }

    function downloadFile(filename, text) {
        const blob = new Blob([text], { type: 'text/plain;charset=utf-8' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = filename;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
    
    function exportData(key) {
        const data = JSON.parse(localStorage.getItem(key));
        if (!data) {
            alert('Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±.');
            return;
        }
        const exportText = formatDataAsText(data);
        const filename = `ØªÙ‚Ø±ÙŠØ±_Ù…Ø¹Ø§Ù…Ù„Ø©_${data.transaction_number || data.transaction_name || new Date().toISOString()}.txt`;
        downloadFile(filename, exportText);
    }

    function exportSelectedData() {
        const checkboxes = document.querySelectorAll('.export-checkbox:checked');
        if (checkboxes.length === 0) {
            alert("ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ Ù…Ø¹Ø§Ù…Ù„Ø© ÙˆØ§Ø­Ø¯Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ù„Ù„ØªØµØ¯ÙŠØ±.");
            return;
        }

        let combinedText = '';
        checkboxes.forEach(checkbox => {
            const key = checkbox.dataset.key;
            const data = JSON.parse(localStorage.getItem(key));
            if (data) {
                combinedText += formatDataAsText(data);
            }
        });
        
        const filename = `ØªÙ‚Ø±ÙŠØ±_Ù…Ø¬Ù…Ø¹_Ù„Ù„Ø£Ø¹Ù…Ø¯Ø©_${new Date().toISOString()}.txt`;
        downloadFile(filename, combinedText);
    }

    window.onload = renderSavedData;
  </script>

</body>
</html>